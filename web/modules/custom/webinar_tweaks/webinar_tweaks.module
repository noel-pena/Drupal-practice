<?php

/**
 * @file
 * Primary module hooks for Webinar Tweaks.
 */

use Drupal\Core\Entity\EntityInterface;
use \Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_entity_presave().
 */
function webinar_tweaks_entity_presave(EntityInterface $entity) {
  // Check if we are saving a 'webinar' node.
  if ($entity->getEntityTypeId() === 'node' && $entity->bundle() === 'webinar') {
    
    // 1. Get the current title.
    $title = $entity->label();
    $prefix = "Webinar: ";

    // 2. Check if the title starts with the prefix.
    if (!str_starts_with($title, $prefix)) {
      // 3. Set the new title.
      $entity->setTitle($prefix . $title);
      // Optional: Log it so we know it happened.
      \Drupal::logger('webinar_tweaks')->info('Fixed title for @title', ['@title' => $entity->label()]);
    }
  }
}

/**
 * Implements hook_form_alter().
 */
function webinar_tweaks_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // We want to target BOTH the "Edit" form AND the "Add" form.
  // The IDs are: 'node_webinar_edit_form' and 'node_webinar_form'.
  if ($form_id === 'node_webinar_edit_form' || $form_id === 'node_webinar_form') {
    // Hide the promote checkbox.
    $form['promote']['#access'] = FALSE;

    // Attach our custom validation handler.
    $form['#validate'][] = 'webinar_tweaks_validate';
  }

  // Log the ID so you can see which one is being used.
  \Drupal::logger('webinar_tweaks')->info('Form ID: @id', ['@id' => $form_id]);
}

function webinar_tweaks_validate(&$form, FormStateInterface $form_state) {
  // 1. Get the raw array for the 'title' field.
  $title = $form_state->getValue(['title', 0, 'value']);

  // 3. Run the logic.
  if (strlen($title) < 5) {
    $form_state->setErrorByName('title', 'Title must be at least 5 characters long.');
  }
}